syntax = "proto3";

package qubic.http.qubic.pb;

option go_package = "github.com/qubic/qubic-http/protobuff/";
import "google/api/annotations.proto";
import "google/protobuf/empty.proto";

import "openapiv3/annotations.proto";

option (openapi.v3.document) = {
  info: {
    title: "Qubic Live API"
    description: "Bridge service for Qubic network operations."
    version: "1.0.0"
  }
  servers: [
    {
      url: "https://rpc.qubic.org/live/v1"
    }
  ]
  external_docs: {
    description: "GitHub"
    url: "https://github.com/qubic/qubic-http"
  }

  tags: [
    {
      name: "Assets"
      description: "Query and manage assets including issuances, ownerships, and possessions."
    },
    {
      name: "Accounts"
      description: "Check account balances and transfer history."
    },
    {
      name: "Network"
      description: "Network status and tick information."
    },
    {
      name: "Transactions"
      description: "Broadcast transactions to the network."
    },
    {
      name: "Smart Contracts"
      description: "Query smart contracts and view active IPOs."
    }
  ]
};

// Balance
message Balance {
  string id = 1 [(openapi.v3.property)= {description: "The identity relevant to this balance."}];
  int64 balance = 2 [(openapi.v3.property)= {description: "The amount of funds the identity holds."}];
  uint32 valid_for_tick = 3 [(openapi.v3.property)= {description: "The tick that this balance is valid for."}];
  uint32 latest_incoming_transfer_tick = 4 [(openapi.v3.property)= {description: "The last tick when this identity received funds through a transfer."}];
  uint32 latest_outgoing_transfer_tick = 5 [(openapi.v3.property)= {description: "The last tick when this identity sent funds through a transfer."}];
  int64 incoming_amount = 6 [(openapi.v3.property)= {description: "The total sum of received funds over time."}];
  int64 outgoing_amount = 7 [(openapi.v3.property)= {description: "The total sum of sent funds over time."}];
  uint32 number_of_incoming_transfers = 8 [(openapi.v3.property)= {description: "The number of incoming transfers."}];
  uint32 number_of_outgoing_transfers = 9 [(openapi.v3.property)= {description: "The number of outgoing transfers."}];
}

// GetBalanceRequest
message GetBalanceRequest {
  string id = 1;
}

// GetBalanceResponse
message GetBalanceResponse {
  Balance balance = 1;
}

// BroadcastTransactionRequest
message BroadcastTransactionRequest {
  //
  string encoded_transaction = 1 [(openapi.v3.property) =  {description: "Base64 encoded binary transaction data."}];
}

// BroadcastTransactionResponse
message BroadcastTransactionResponse {
  int32 peers_broadcasted = 1 [(openapi.v3.property) = {description: "The number of Qubic node peers this transactions has been broadcast to."}];
  string encoded_transaction = 2 [(openapi.v3.property) = {description: "The Base 64 encoded binary transaction from the request."}];
  string transaction_id = 3 [(openapi.v3.property) = {description: "The id / hash of the transaction."}];
}

// TickInfo
message TickInfo {
  // current network tick
  uint32 tick = 1;
  uint32 duration = 2;
  // current epoch
  uint32 epoch = 3;
  // initial tick of epoch
  uint32 initial_tick = 4;
}

// GetTickInfoResponse
message GetTickInfoResponse {
  TickInfo tick_info = 1;
}

// GetBlockHeightResponse
message GetBlockHeightResponse {
  TickInfo block_height = 1;
}

// AssetInfo
message AssetInfo {
  uint32 tick = 1;
  uint32 universe_index = 2;
}

// IssuedAssetData
message IssuedAssetData {
  string issuer_identity = 1;
  uint32 type = 2;
  string name = 3;
  int32 number_of_decimal_places = 4;
  repeated int32 unit_of_measurement = 5;
}

// IssuedAsset
message IssuedAsset {
  IssuedAssetData data = 1;
  AssetInfo info = 2;
}

// IssuedAssetsRequest
message IssuedAssetsRequest {
  string identity = 1;
}

// IssuedAssetsResponse
message IssuedAssetsResponse {
  repeated IssuedAsset issued_assets = 1;
}

// OwnedAssetData
message OwnedAssetData {
  string owner_identity = 1;
  uint32 type = 2;
  int32 padding = 3;
  uint32 managing_contract_index = 4;
  uint32 issuance_index = 5;
  int64 number_of_units = 6;
  IssuedAssetData issued_asset = 7;
}

// OwnedAsset
message OwnedAsset {
  OwnedAssetData data = 1;
  AssetInfo info = 2;
}

// OwnedAssetsRequest
message OwnedAssetsRequest {
  string identity = 1;
}

// OwnedAssetsResponse
message OwnedAssetsResponse {
  repeated OwnedAsset owned_assets = 1;
}

// PossessedAssetData
message PossessedAssetData {
  string possessor_identity = 1;
  uint32 type = 2;
  int32 padding = 3;
  uint32 managing_contract_index = 4;
  uint32 issuance_index = 5;
  int64 number_of_units = 6;
  OwnedAssetData owned_asset = 7;
}

// PossessedAsset
message PossessedAsset {
  PossessedAssetData data = 1;
  AssetInfo info = 2;
}

// PossessedAssetsRequest
message PossessedAssetsRequest {
  string identity = 1;
}

// PossessedAssetsResponse
message PossessedAssetsResponse {
  repeated PossessedAsset possessed_assets = 1;
}

// QuerySmartContractRequest
message QuerySmartContractRequest {
  // identifies the smart contract
  uint32 contract_index = 1;
  // identifies the function to be queried
  uint32 input_type = 2;
  // the size of the input data (request data)
  uint32 input_size = 3;
  // base64 encoded input data
  string request_data = 4;
}

// QuerySmartContractResponse
message QuerySmartContractResponse {
  string response_data = 5 [(openapi.v3.property)= {description: "Binary data encoded as Base64. This data is returned directly from the called SC function."}];
}

// AssetIssuanceData
message AssetIssuanceData {
  string issuer_identity = 1;
  uint32 type = 2;
  string name = 3;
  int32 number_of_decimal_places = 4;
  repeated int32 unit_of_measurement = 5;
}

// AssetIssuance
message AssetIssuance {
  AssetIssuanceData data = 1;
  uint32 tick = 2;
  uint32 universe_index = 3;
}

// AssetIssuances
message AssetIssuances {
  repeated AssetIssuance assets = 1;
}

// AssetOwnershipData
message AssetOwnershipData {
  string owner_identity = 1;
  uint32 type = 2;
  uint32 managing_contract_index = 3;
  uint32 issuance_index = 4;
  int64 number_of_units = 5;
}

// AssetOwnership
message AssetOwnership {
  AssetOwnershipData data = 1;
  uint32 tick = 2;
  uint32 universe_index = 3;
}

// AssetOwnerships
message AssetOwnerships {
  repeated AssetOwnership assets = 1;
}

// AssetPossessionData
message AssetPossessionData {
  string possessor_identity = 1;
  uint32 type = 2;
  uint32 managing_contract_index = 3;
  uint32 ownership_index = 4;
  int64 number_of_units = 5;
}

// AssetPossession
message AssetPossession {
  AssetPossessionData data = 1;
  uint32 tick = 2;
  uint32 universe_index = 3;
}

// AssetPossessions
message AssetPossessions {
  repeated AssetPossession assets = 1;
}

// GetByUniverseIndexRequest
message GetByUniverseIndexRequest {
  uint32 index = 1;
}

// GetIssuedAssetsByFilterRequest
message GetIssuedAssetsByFilterRequest {
  string issuer_identity = 1;
  string asset_name = 2;
}

// GetOwnedAssetsByFilterRequest
message GetOwnedAssetsByFilterRequest {
  // Identity of the issuer. Defaults to the zero address (smart contract shares).
  string issuer_identity = 1;
  // Name of the asset (required).
  string asset_name = 2;
  // Identity of the owner of the asset (optional).
  string owner_identity = 3;
  // Index of the contract that manages the ownership (optional).
  uint32 ownership_managing_contract = 4;
}

// GetPossessedAssetsByFilterRequest
message GetPossessedAssetsByFilterRequest {
  // Identity of the issuer (required). Defaults to the zero address (smart contract shares).
  string issuer_identity = 1;
  // Name of the asset (required).
  string asset_name = 2;
  // Identity of the owner of the asset (optional).
  string owner_identity = 3;
  // Identity of the possessor of the asset (optional).
  string possessor_identity = 4;
  // Index of the contract that manages the ownership (optional).
  uint32 ownership_managing_contract = 5;
  // Index of the contract that manages the possession (optional).
  uint32 possession_managing_contract = 6;
}

// IPO
message Ipo {
  // The index of the related contract (contract address).
  uint32 contract_index = 1;
  // The name of the related asset.
  string asset_name = 2;
}

// GetActiveIposResponse
message GetActiveIposResponse {
  repeated Ipo ipos = 1;
}

service QubicLiveService {

  rpc GetBalance(GetBalanceRequest) returns (GetBalanceResponse) {
    option (openapi.v3.operation) = {
      tags: ["Accounts"]
      summary: "Get Balance"
      description: "Gets the balance of the specified identity."
    };
    option (google.api.http) = {
      get: "/balances/{id}"
    };
  };

  rpc QuerySmartContract(QuerySmartContractRequest) returns (QuerySmartContractResponse) {
    option (openapi.v3.operation) = {
      tags: ["Smart Contracts"]
      summary: "Query Smart Contract"
      description: "Queries a smart contract function."
    };
    option (google.api.http) = {
      post: "/querySmartContract"
      body: "*"
    };
  };

  rpc BroadcastTransaction(BroadcastTransactionRequest) returns (BroadcastTransactionResponse) {
    option (openapi.v3.operation) = {
      tags: ["Transactions"]
      summary: "Broadcast Transaction"
      description: "Broadcasts a transaction to the network."
    };
    option (google.api.http) = {
      post: "/broadcast-transaction"
      body: "*"
    };
  };

  rpc GetTickInfo(google.protobuf.Empty) returns (GetTickInfoResponse) {
    option (openapi.v3.operation) = {
      tags: ["Network"]
      summary: "Get Tick Info"
      description: "Gets the current tick information."
    };
    option (google.api.http) = {
      get: "/tick-info"
    };
  };

  rpc GetBlockHeight(google.protobuf.Empty) returns (GetBlockHeightResponse) {
    option (openapi.v3.operation) = {
      tags: ["Network"]
      summary: "Get Block Height"
      description: "Deprecated: use /tick-info instead."
      deprecated: true
    };
    option (google.api.http) = {
      get: "/block-height"
    };
  };

  rpc GetIssuedAssets(IssuedAssetsRequest) returns (IssuedAssetsResponse) {
    option (openapi.v3.operation) = {
      tags: ["Assets"]
      summary: "List Issued Assets"
      description: "Gets assets issued by the specified identity."
    };
    option (google.api.http) = {
      get: "/assets/{identity}/issued"
    };
  };

  rpc GetOwnedAssets(OwnedAssetsRequest) returns (OwnedAssetsResponse) {
    option (openapi.v3.operation) = {
      tags: ["Assets"]
      summary: "List Owned Assets"
      description: "Gets assets that are owned by the specified identity."
    };
    option (google.api.http) = {
      get: "/assets/{identity}/owned"
    };
  };


  rpc GetPossessedAssets(PossessedAssetsRequest) returns (PossessedAssetsResponse) {
    option (openapi.v3.operation) = {
      tags: ["Assets"]
      summary: "List Possessed Assets"
      description: "Gets assets that are possessed by the specified identity."
    };
    option (google.api.http) = {
      get: "/assets/{identity}/possessed"
    };
  };

  rpc GetIssuedAssetsByFilter(GetIssuedAssetsByFilterRequest) returns (AssetIssuances) {
    option (openapi.v3.operation) = {
      tags: ["Assets"]
      summary: "Search Asset Issuances"
      description: "Returns a list of issued assets filtered by issuer identity and asset name."
    };
    option (google.api.http) = {
      get: "/assets/issuances"
    };
  }

  rpc GetIssuedAssetByUniverseIndex(GetByUniverseIndexRequest) returns (AssetIssuance) {
    option (openapi.v3.operation) = {
      tags: ["Assets"]
      summary: "Get Asset Issuance By Index"
      description: "Returns an asset issuance by universe index."
    };
    option (google.api.http) = {
      get: "/assets/issuances/{index}"
    };
  }

  rpc GetOwnedAssetsByFilter(GetOwnedAssetsByFilterRequest) returns (AssetOwnerships) {
    option (openapi.v3.operation) = {
      tags: ["Assets"]
      summary: "Search Asset Ownerships"
      description: "Returns a list of asset ownerships filtered by issuer, asset name, owner and managing contract."
    };
    option (google.api.http) = {
      get: "/assets/ownerships"
    };
  }

  rpc GetOwnedAssetByUniverseIndex(GetByUniverseIndexRequest) returns (AssetOwnership) {
    option (openapi.v3.operation) = {
      tags: ["Assets"]
      summary: "Get Asset Ownership By Index"
      description: "Returns an asset ownership by universe index."
    };
    option (google.api.http) = {
      get: "/assets/ownerships/{index}"
    };
  }

  rpc GetPossessedAssetsByFilter(GetPossessedAssetsByFilterRequest) returns (AssetPossessions) {
    option (openapi.v3.operation) = {
      tags: ["Assets"]
      summary: "Search Asset Possessions"
      description: "Returns a list of asset possessions filtered by issuer, asset name, owner, possessor and managing contracts."
    };
    option (google.api.http) = {
      get: "/assets/possessions"
    };
  }

  rpc GetPossessedAssetByUniverseIndex(GetByUniverseIndexRequest) returns (AssetPossession) {
    option (openapi.v3.operation) = {
      tags: ["Assets"]
      summary: "Get Asset Possession By Index"
      description: "Returns an asset possession by universe index."
    };
    option (google.api.http) = {
      get: "/assets/possessions/{index}"
    };
  }

  rpc GetActiveIpos(google.protobuf.Empty) returns (GetActiveIposResponse) {
    option (openapi.v3.operation) = {
      tags: ["Smart Contracts"]
      summary: "Get Active IPOs"
      description: "Returns a list of IPOs that are active in the current epoch."
    };
    option (google.api.http) = {
      get: "/ipos/active"
    };
  }
}